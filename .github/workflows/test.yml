name: tests

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install
        working-directory: ggplot2

      - name: Sync deps
        run: uv sync --frozen
        working-directory: ggplot2

      - name: Smoke import
        run: |
          uv run python - <<'PY'
          import tempfile
          from pathlib import Path
          import pandas as pd
          from ggplot import (
              ggplot,
              aes,
              after_stat,
              geom_point,
              geom_line,
              geom_bar,
              geom_histogram,
              labs,
              theme,
              theme_minimal,
              facet_wrap,
              scale_x_continuous,
              scale_color_manual,
              scale_fill_manual,
              ggsave,
          )

          df = pd.DataFrame({'x':[1,2,3,1,2,3], 'y':[2,3,5,2,3,4], 'g':['a','a','a','b','b','b']})

          p = (
              ggplot(df, aes('x', 'y'))
              + geom_point()
              + labs(title='t', x='X', y='Y')
              + theme(font='Arial')
              + theme_minimal()
              + facet_wrap('g', ncol=2)
              + scale_x_continuous(limits=(0, 10), breaks=[0, 5, 10])
          )

          fig = p.draw()
          assert len(fig.data) == 2  # one geom trace per facet panel
          assert fig.layout.title.text == 't'
          assert list(fig.layout.xaxis.range) == [0, 10]
          assert list(fig.layout.xaxis.tickvals) == [0, 5, 10]

          # Discrete color manual scale (legend via trace splitting)
          p2 = ggplot(df, aes('x', 'y', color='g')) + geom_point() + scale_color_manual({'a': 'red', 'b': 'blue'})
          fig2 = p2.draw()
          assert len(fig2.data) == 2
          assert set(t.name for t in fig2.data) == {'a', 'b'}

          # geom_line
          p3 = ggplot(df, aes('x', 'y', group='g')) + geom_line()
          fig3 = p3.draw()
          assert len(fig3.data) == 2

          # geom_bar + after_stat('count')
          df_bar = pd.DataFrame({'x': ['a', 'a', 'b']})
          p4 = ggplot(df_bar, aes('x', y=after_stat('count'))) + geom_bar()
          fig4 = p4.draw()
          assert len(fig4.data) == 1
          assert list(fig4.data[0].y) == [2, 1]

          # stacked bars with fill
          df_fill = pd.DataFrame({'x': ['a', 'a', 'a', 'b', 'b'], 'fill': ['u', 'v', 'u', 'u', 'v']})
          p6 = ggplot(df_fill, aes('x', fill='fill')) + geom_bar(position='stack') + scale_fill_manual({'u': '#ff0000', 'v': '#0000ff'})
          fig6 = p6.draw()
          assert len(fig6.data) == 2
          assert set(t.name for t in fig6.data) == {'u', 'v'}

          # geom_histogram
          p5 = ggplot(pd.DataFrame({'x': [1, 1, 2, 3, 3, 3]}), aes('x')) + geom_histogram(bins=3)
          fig5 = p5.draw()
          assert len(fig5.data) == 1

          with tempfile.TemporaryDirectory() as d:
              out = Path(d) / 'plot.png'
              ggsave(out, plot=p, width=300, height=200)
              assert out.exists()
          PY
        working-directory: ggplot2
